<?php namespace Mom\Http\Controllers;

use Mom\Models\Project;
use Mom\Models\ProjectMeta;
use Mom\Models\NemoEntity;
use Mom\Models\User;
use Mom\Models\Role;
use Mom\Http\Requests;
use Mom\Http\Controllers\Controller;
use Mom\Http\Requests\ProjectRequest;
use Carbon\Carbon;

class ProjectController extends Controller
{

    public function __construct(){
        // apply middleware as needed
        // use 'only' instead of 'except' if it's a short array
        $this->middleware('auth', ['except' => [
            'work',
        ]]);
        $this->middleware('admin', ['except' => [
            'work',
        ]]);
    }

    /**
     * Generate new project_id.
     *
     * @return Integer project_id
     */
    private function generateProjectNewID() {
        $latestID = NemoEntity::where('entities_id', 'LIKE', 'projects:%')->latest()->first()->entities_id;
        // split string 'projects:#' into an array with ':' delimiter and then append 'projects:' after adding 1
        $project_id = explode(':', $latestID);
        return 'projects:' . (array_pop($project_id) + 1);
    }

    /**
     * Display a listing of the resource.
     *
     * @return \Illuminate\Http\Response
     */
    public function index()
    {
         $projects = Project::with(['meta', 'productOwners', 'scrumMasters', 'members'])->orderBy('updated_at', 'DESC')->get();
        // remove 'projects:' from project_id to only have the integers
        // Take into account projects with no product owner and scrum master
        // if count > 0 then it is true
        foreach($projects as $project) {
            $id = explode(':', $project->project_id);
            $project->project_id = array_pop($id);
        }
        
        // use $project->product_owner & $project->scrum_master on the view
        // look at Project model for more information
        return view('pages.projects.index', compact('projects'));
    }

    /**
     * Show the form for creating a new resource.
     *
     * @return \Illuminate\Http\Response
     */
    public function create()
    {
        $users = User::where('status', 'Active')->get()->lists('display_name', 'user_id');
        // Change view as needed
        return view('pages.projects.create', compact('users'));
    }

    /**
     * Store a newly created resource in storage.
     *
     * @param  \Illuminate\Http\Request  $request
     * @return \Illuminate\Http\Response
     */
    public function store(ProjectRequest $request)
    {
        // CreateProjectRequest validates both models columns
        // project_id must be generated by retrieving most recent one 
        // from entities table in nemo
        $project_id = ($this->generateProjectNewID());
        $title = $request->title;
        $project_link = $request->project_link ?: NULL;
        $description = $request->description;
        $start_date = $request->start_date;
        $end_date = $request->end_date  === "" ? NULL : $request->end_date;
        // product_owner and scrum_master are required fields validated in CreateProjectRequest
        $product_owner = $request->product_owner;
        $scrum_master = $request->scrum_master;
        // expecting a list of user_id's
        $members = $request->members;
        // account for an empty array

        try {
            NemoEntity::create([
                'entities_id' => $project_id,
                'parent_entities_id' => 'departments:10390',
                'entity_type' => 'Project',
                'display_name' => $title,
                'description' => $description,
            ]);

             $project = Project::create([
                'project_id' => $project_id,
                'start_date' => $start_date,
                'end_date'   => $end_date,
            ]);
        } 
        catch (\PDOException $e) {
            // add some sort of notification of error
            return redirect()->back();
        }

        // lazy load relationships to add PO, SM, and members.
        $project->load('meta', 'productOwners', 'scrumMasters', 'members', 'projectLinks');
        // Only add product_owner and scrum_master roles into the project if $product_owner and $scrum_master exists
        if(!empty($product_owner))
            $project->productOwners()->sync([$product_owner => ['role_position' => 'product_owner']]);
        if(!empty($scrum_master))
            $project->scrumMasters()->sync([$scrum_master => ['role_position' => 'scrum_master']]);

        $membersToAdd = array();
        // $members comes in as an array 
        if(isset($members)) {
            foreach ($members as $value) {
                $membersToAdd[$value] = ['role_position' => 'member'];
            }
        }
        $project->members()->sync($membersToAdd);

        // store project_link, if one entered
        if(!empty($project_link))
            $project->projectLinks()->sync([$project->project_id => ['link_id' => '5', 'link_url' => $project_link]]);

        return redirect()->to('projects');
    }

    /**
     * Display the specified resource.
     *
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function show($id)
    {   
        // Look in app/Exceptions/Handler.php for how a
        // ModelNotFoundException exception will be caught for
        // findOrFail under the /project URI
        // eager load relationships as well
        $project = Project::with('meta', 'members', 'productOwners', 'scrumMasters', 'projectLinks')->findOrFail('projects:' . $id);
        $project->project_id = $id;
        
        // use $project->product_owner & $project->scrum_master on the view
        // look at Project model for more information
        return view('pages.projects.show', compact('project'));
    }

    /**
     * Show the form for editing the specified resource.
     *
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function edit($id)
    {
        // Look in app/Exceptions/Handler.php for how a
        // ModelNotFoundException exception will be caught for
        // findOrFail under the /project URI
        // eager load relationships as well
        $project = Project::with(['meta', 'productOwners', 'scrumMasters', 'members', 'projectLinks'])->findOrFail('projects:' . $id);
        $project->project_id = $id;

        // Take into account projects with no product owner and scrum master
        // if count > 0 then it is true
        $users = User::where('status', 'Active')->get()->lists('display_name', 'user_id');
        // Change view as needed
         
        //return members to the view as well.
        $members = $project->members->pluck('user_id')->toArray();

        // use $project->product_owner, $project->scrum_master & $project->project_link on the view
        // look at Project model for more information
        return view('pages.projects.edit', compact('project', 'users', 'members'));
    }

    /**
     * Update the specified resource in storage.
     *
     * @param  \Illuminate\Http\Request  $request
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function update(ProjectRequest $request, $id)
    {     
        // Look in app/Exceptions/Handler.php for how a
        // ModelNotFoundException exception will be caught for
        // findOrFail under the /project URI
        // Columns are updated in their respective models
        $projectMeta = NemoEntity::findOrFail('projects:' . $id);
        try {
            $projectMeta->fill([
                'display_name'  =>  $request->title,
                'description'   =>  $request->description,
            ]);
            $projectMeta->save();
            $projectMeta->touch();
        } catch (\PDOException $e){
            // add some sort of notification of error
            return redirect()->back();
        }
        
        $project = Project::findOrFail('projects:' . $id);
        try {
            $project->fill([
                'start_date' =>  $request->start_date,
                'end_date'   =>  $request->end_date  === "" ? NULL: $request->end_date,
            ]);
            $project->save();
            $project->touch();
        } catch (\PDOException $e) {
            // add some sort of notification of error
            return redirect()->back();
        }

        // lazy load relationships to update PO, SM, and members. Also title and description (meta).
        $project->load('productOwners', 'scrumMasters', 'members', 'meta', 'projectLinks');

        // Checks to see if the product owner or scrum master slots are empty strings before syncing.
        // The sync method accepts an array of IDs with it's associated role to store. 
        // If Any IDs with it's associated role are not in the given array that were on the table before, will be removed.
        // Must use associate array to attach the role to members id as a key
        $emptyArr = array();
        if(!empty($request->product_owner))
            $project->productOwners()->sync([$request->product_owner => ['role_position' => 'product_owner']]);
        else
            $project->productOwners()->sync($emptyArr);
        
        if(!empty($request->scrum_master))
            $project->scrumMasters()->sync([$request->scrum_master => ['role_position' => 'scrum_master']]);
        else 
            $project->scrumMasters()->sync($emptyArr);

        // Update members in this project with sync as well
        $updatedMembers = array(); 
        if(isset($request->members)) {
            foreach ($request->members as $value) {
                $updatedMembers[$value] = ['role_position' => 'member'];
            }
        }
        $project->members()->sync($updatedMembers);
        
        // update project_link
        if(!empty($request->project_link))
            $project->projectLinks()->sync([$project->project_id => ['link_id' => '5', 'link_url' => $request->project_link]]);
        else
            $project->projectLinks()->sync($emptyArr);

        return redirect()
                ->to('projects')
                ->with('message', "Project {$project->meta->title} updated successfully!");
    }

    /**
     * Remove the specified resource from storage.
     *
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function destroy($id)
    {
        // Look in app/Exceptions/Handler.php for how a
        // ModelNotFoundException exception will be caught for
        // findOrFail under the /project URI
        // Must be deleted on both models
        // projects and respective relationships are just being deleted for testing purposes
        $project = Project::with(['meta', 'productOwners', 'scrumMasters', 'members'])->findOrFail('projects:' . $id);
        $project->productOwners()->sync([]);
        $project->scrumMasters()->sync([]);
        $project->members()->sync([]);
        $project->projectLinks()->sync([]);
        $project->delete();
        $projectMeta = NemoEntity::findOrFail('projects:' . $id);
        $projectMeta->delete();

        return redirect()
            ->to('project/')
            ->with('message', "Project {$project->meta->title} has been deleted successfully!");
    }

    public function work(){
        $projects = Project::with([
            'meta', 
            'productOwners.profile.links', 'productOwners.profile.skills', 'productOwners.profile.experience', 'productOwners.profile.image',
            'scrumMasters.profile.links', 'scrumMasters.profile.skills', 'scrumMasters.profile.experience', 'scrumMasters.profile.image', 
            'members.profile.links', 'members.profile.skills', 'members.profile.experience', 'members.profile.image',
            'projectLinks',
            ])
            ->get();
        
        // use $project->product_owner, $project->scrum_master & $project->project_link on the view
        // look at Project model for more information
        return view('pages.projects.work', compact('projects'));
    }
}
